<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ApplicationServiceMpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">funding</a> &gt; <a href="index.source.html" class="el_package">com.example.funding.service.Application</a> &gt; <span class="el_source">ApplicationServiceMpl.java</span></div><h1>ApplicationServiceMpl.java</h1><pre class="source lang-java linenums">package com.example.funding.service.Application;

import cn.dev33.satoken.stp.StpUtil;
import cn.dev33.satoken.util.SaResult;
import cn.hutool.json.JSONObject;
import com.alibaba.excel.EasyExcel;
import com.alibaba.excel.support.ExcelTypeEnum;
import com.example.funding.bean.*;
import com.example.funding.dao.*;
import com.example.funding.service.Group.GroupInfo;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;
import org.thymeleaf.util.DateUtils;
import org.thymeleaf.util.NumberUtils;
import org.thymeleaf.util.StringUtils;

import javax.servlet.http.HttpServletResponse;
import java.io.*;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.time.Instant;
import java.time.LocalDate;
import java.time.ZoneId;
import java.time.ZonedDateTime;
import java.util.*;
import java.util.regex.Pattern;

@Service
@Transactional
<span class="fc" id="L34">public class ApplicationServiceMpl implements ApplicationService{</span>

    @Autowired
    ExpenditureDao expenditureDao;
    @Autowired
    UserDao userDao;
    @Autowired
    ApplicationDao applicationDao;
    @Autowired
    GroupDao groupDao;
    @Autowired
    FeedbackDao feedbackDao;

    public ExpendCategory getCategoryValueFromStrings(String cate1, String cate2){
        ExpendCategory expendCategory;
<span class="fc bfc" id="L49" title="All 6 branches covered.">        switch (cate1){</span>
            case &quot;Office&quot;:{
<span class="fc" id="L51">                expendCategory = ExpendCategory.Office.valueOf(cate2);</span>
<span class="fc" id="L52">                break;</span>
            }
            case &quot;Print&quot;:{
<span class="fc" id="L55">                expendCategory = ExpendCategory.Print.valueOf(cate2);</span>
<span class="fc" id="L56">                break;</span>
            }
            case &quot;Maintenance&quot;:{
<span class="fc" id="L59">                expendCategory = ExpendCategory.Maintenance.valueOf(cate2);</span>
<span class="fc" id="L60">                break;</span>
            }
            case &quot;Postage&quot;:{
<span class="fc" id="L63">                expendCategory = ExpendCategory.Postage.valueOf(cate2);</span>
<span class="fc" id="L64">                break;</span>
            }
            case &quot;Train&quot;:{
<span class="fc" id="L67">                expendCategory = ExpendCategory.Train.valueOf(cate2);</span>
<span class="fc" id="L68">                break;</span>
            }
<span class="fc" id="L70">            default:expendCategory = ExpendCategory.Error.noSuchCategory;</span>
        }
<span class="fc" id="L72">        return expendCategory;</span>
    }

    public static boolean isInteger(String str) {
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">        if (str == null) {</span>
<span class="nc" id="L77">            return false;</span>
        }
<span class="fc" id="L79">        Pattern pattern = Pattern.compile(&quot;^[-\\+]?[\\d]+$&quot;);</span>
<span class="fc" id="L80">        return pattern.matcher(str).matches();</span>
    }

    public static boolean isDouble(String str) {
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">        if (str == null) {</span>
<span class="nc" id="L85">            return false;</span>
        }
<span class="fc" id="L87">        Pattern pattern = Pattern.compile(&quot;^[-\\+]?[.\\d]*$&quot;);</span>
<span class="fc" id="L88">        return pattern.matcher(str).matches();</span>
    }

    /**
     * AppInfo getAppInfoByNumber(String expendNumber, long staffId)
     * @param expendNumber
     * @param staffId
     * @return
     */
    @Override
    public SaResult getAppInfoByNumber(String expendNumber, long staffId) {
//        List&lt;Expenditure&gt; expenditures = expenditureDao.findByNumber(expendNumber);
<span class="nc" id="L100">        Expenditure expenditure = expenditureDao.findByNumberAndStatus(expendNumber, 1);</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if(expenditure == null){</span>
<span class="nc" id="L102">            return SaResult.error(String.format(&quot;this expenditure of %s is not exist\n&quot;, expendNumber));</span>
        }
<span class="nc" id="L104">        AppInfo appInfo = new AppInfo(expenditure);</span>
<span class="nc" id="L105">        appInfo.setUserId(staffId);</span>
<span class="nc" id="L106">        appInfo.setUserName(userDao.findByUserId(staffId).getName());</span>
<span class="nc" id="L107">        return SaResult.ok().setData(appInfo);</span>
    }

    /*
    失败的可能情况：
    1. 金额超过限定
    2.
    3. 将app加入到对应管理者的set里可能失败
     */
    @Override
    public SaResult submitApplication(String expendNumber, String expendCategory1, String expendCategory2,
                                      String abstrac , String comment, String amount, long userId) {
<span class="fc" id="L119">        return  saveApplication(expendNumber, expendCategory1, expendCategory2,</span>
                abstrac , comment, amount, userId, 0);
    }

    public SaResult tempSaveApplication(String expendNumber, String expendCategory1, String expendCategory2, String abstrac ,
                                 String comment, String amount, long userId){
<span class="nc" id="L125">        return saveApplication(expendNumber, expendCategory1, expendCategory2,</span>
                abstrac , comment, amount, userId, 4);
    }
    public SaResult getTempSaveApp(Long userId){
<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (userId == null){</span>
<span class="nc" id="L130">            return SaResult.error(&quot;userId is null&quot;);</span>
        }
<span class="nc" id="L132">        List&lt;Application&gt; applications = applicationDao.findByUser_IdAndStatus(userId, 4);</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (applications.size() == 0){</span>
<span class="nc" id="L134">            return SaResult.error(&quot;no temp save&quot;);</span>
        }
<span class="nc" id="L136">        Application application = new Application();</span>
<span class="nc" id="L137">        application.setComment(&quot;no app find&quot;);</span>
<span class="nc" id="L138">        return SaResult.ok().setData(new AppInfo(applications.stream()</span>
<span class="nc" id="L139">                .max(Comparator.comparing(Application::getCreatedDate)).orElse(application)));</span>

    }
    private SaResult saveApplication(String expendNumber, String expendCategory1, String expendCategory2,
                                     String abstrac , String comment, String amount, long userId, int saveStatus) {
//        List&lt;Expenditure&gt; expenditures = expenditureDao.findByNumber(expendNumber);
<span class="fc" id="L145">        Expenditure expenditure = expenditureDao.findByNumberAndStatus(expendNumber, 1);</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">        if(expenditure == null){</span>
<span class="nc" id="L147">            return SaResult.error(String.format(&quot;this expenditure of %s is not exist\n&quot;, expendNumber));</span>
        }
<span class="fc" id="L149">        ExpendCategory expCategory =getCategoryValueFromStrings(expendCategory1, expendCategory2);</span>
<span class="fc" id="L150">        int expCate = expCategory.getValueOfExpend(expCategory);</span>
<span class="fc" id="L151">        double amt = 0.0;</span>
//        if(isInteger(expendCategory)){
//            expCate = Integer.parseInt(expendCategory);
//        }else{
//            return SaResult.error(&quot;this category is not integer&quot;);
//        }
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">        if (isDouble(amount)){</span>
<span class="fc" id="L158">            amt = Double.parseDouble(amount);</span>
        }else{
<span class="nc" id="L160">            return SaResult.error(&quot;this amount is not double&quot;);</span>
        }
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">        if (amt + (Double)getQuota(expendNumber).getData() &gt; expenditure.getQuota()){</span>
<span class="nc" id="L163">            return SaResult.error(&quot;over quota&quot;);</span>
        }
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">        if(amt &gt; expenditure.getRemainingAmount()){</span>
<span class="nc" id="L166">            return SaResult.error(&quot;the amount requested exceeds the limit &quot;);</span>
        }
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">        if (expenditure.getStatus() != 1){</span>
<span class="nc" id="L169">            return SaResult.error(String.format(&quot;the status of expenditure is wrong; status: %d&quot;, expenditure.getStatus()));</span>
        }
<span class="fc" id="L171">        User user = userDao.findByUserId(userId);</span>
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">        if (user == null){</span>
<span class="nc" id="L173">            return SaResult.error(String.format(&quot;user of %d is not exist&quot;, userId));</span>
        }
<span class="fc" id="L175">        Application application = new Application();</span>
<span class="fc" id="L176">        application.setCreatedDate(new Date());</span>
<span class="fc" id="L177">        application.setApplyTime(new Date());</span>
<span class="fc" id="L178">        application.setApp_abstract(abstrac);</span>
<span class="fc" id="L179">        application.setComment(comment);</span>
<span class="fc" id="L180">        application.setUser(user);</span>
<span class="fc" id="L181">        application.setExpenditure(expenditure);</span>
<span class="fc" id="L182">        application.setStatus(saveStatus);</span>
<span class="fc" id="L183">        application.setType(1);</span>
<span class="fc" id="L184">        application.setAmount(amt);</span>
<span class="fc" id="L185">        application.setExpendCategory(expCate);</span>
<span class="fc" id="L186">        Application application1 = applicationDao.save(application);</span>

<span class="fc" id="L188">        Group group = expenditure.getGroup();</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">        if (saveStatus == 0){</span>
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">            group.getUsers().stream().filter(s-&gt;s.getIdentity()&gt;0).forEach(s-&gt;s.getAppToExam().add(application1));</span>
<span class="fc" id="L191">            expenditureDao.updateRemainingAmountByNumber(expenditure.getRemainingAmount()-amt, expendNumber);</span>
        }
<span class="fc" id="L193">        user.getApplications().add(application1);</span>
//        group.getUsers().stream().forEach(s-&gt;userDao.save(s));

<span class="fc" id="L196">        return SaResult.ok().setData(application1.getId());</span>
    }

    @Override
    public SaResult withdrawApplication(String appId) {
<span class="nc" id="L201">        long appID = 0;</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">        if (isInteger(appId)){</span>
<span class="nc" id="L203">            appID = Integer.parseInt(appId);</span>
        }else{
<span class="nc" id="L205">            return SaResult.error(&quot;this id is not int&quot;);</span>
        }
//        System.out.println(System.currentTimeMillis());
<span class="nc" id="L208">        Application application = applicationDao.findById(appID);</span>
<span class="nc" id="L209">        System.out.println(System.currentTimeMillis());</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">        if(application == null){</span>
<span class="nc" id="L211">            return SaResult.error(&quot;this app is not present&quot;);</span>
        }
<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (application.getUser().getId() != StpUtil.getLoginIdAsLong()){</span>
<span class="nc" id="L214">            return SaResult.error(&quot;you have no right to withdraw, as it belongs to someone else;&quot;);</span>
        }
<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (application.getStatus() != 0){</span>
<span class="nc" id="L217">            return SaResult.error(&quot;this application has been examined&quot;);</span>
        }
<span class="nc" id="L219">        System.out.println(System.currentTimeMillis());</span>
//        设置成撤销状态
<span class="nc" id="L221">        Expenditure expenditure = application.getExpenditure();</span>
<span class="nc" id="L222">        expenditureDao.updateRemainingAmountByNumber(</span>
<span class="nc" id="L223">                application.getExpenditure().getRemainingAmount()+application.getAmount(),</span>
<span class="nc" id="L224">                application.getExpenditure().getNumber());</span>
<span class="nc" id="L225">        application.setStatus(3);</span>
<span class="nc" id="L226">        System.out.println(System.currentTimeMillis());</span>
<span class="nc" id="L227">        return SaResult.ok();</span>
    }
    /*
    TODO 获取该基金在这个时间段还有的余额，从基金申请开始一年为一个时间段
     */
    public java.util.Date getLocalDate(java.util.Date date1){
<span class="fc" id="L233">        java.util.Date date = new Date(date1.getTime());</span>
<span class="fc" id="L234">        Instant instant = date.toInstant();</span>
<span class="fc" id="L235">        ZoneId zoneId = ZoneId.systemDefault();</span>
<span class="fc" id="L236">        LocalDate localDate = instant.atZone(zoneId).toLocalDate();</span>
<span class="fc" id="L237">        Date dateNow = new Date();</span>
<span class="fc" id="L238">        instant = dateNow.toInstant();</span>
<span class="fc" id="L239">        LocalDate localDateNow = instant.atZone(zoneId).toLocalDate();</span>
<span class="fc bfc" id="L240" title="All 2 branches covered.">        while (localDate.isBefore(localDateNow)){</span>
<span class="fc" id="L241">            localDate = localDate.plusYears(1);</span>
        }
<span class="fc" id="L243">        localDate = localDate.minusYears(1);</span>
<span class="fc" id="L244">        ZonedDateTime zdt = localDate.atStartOfDay(zoneId);</span>
<span class="fc" id="L245">        return Date.from(zdt.toInstant());</span>
    }
    public SaResult getQuota(String expendNumber){
<span class="fc" id="L248">        Expenditure expenditure = expenditureDao.findByNumberAndStatus(expendNumber, 1);</span>
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">        if (expenditure == null){</span>
<span class="nc" id="L250">            return SaResult.error(&quot;wrong expendNumber, there is no such expenditure&quot;);</span>
        }
<span class="fc" id="L252">        java.util.Date date = expenditure.getStartTime();</span>
<span class="fc" id="L253">        date = getLocalDate(date);</span>
<span class="fc" id="L254">        java.util.Date finalDate = date;</span>
<span class="fc" id="L255">        List&lt;Application&gt; applications = expenditureDao</span>
<span class="fc" id="L256">                .findByNumberAndStatus(expendNumber, 1)</span>
<span class="fc" id="L257">                .getApplications().stream()</span>
<span class="pc bpc" id="L258" title="2 of 4 branches missed.">                .filter(s-&gt;s.getCreatedDate().after(finalDate) &amp;&amp; s.getStatus()&lt;=1)</span>
<span class="fc" id="L259">                .toList();</span>
<span class="fc" id="L260">        return SaResult.ok().setData(applications.stream().mapToDouble(Application::getAmount).sum());</span>
    }
    /*
    获取自己提交的所有申请
     */
    public SaResult getMyApps(long userId){
<span class="nc bnc" id="L266" title="All 2 branches missed.">        if(userDao.findByUserId(userId) == null){</span>
<span class="nc" id="L267">            return SaResult.error(&quot;the user is not exist&quot;);</span>
        }
<span class="nc" id="L269">        List&lt;AppInfo&gt; appInfos = userDao.findByUserId(userId).getApplications().stream()</span>
<span class="nc" id="L270">                .sorted(Comparator.comparing(Application::getStatus).</span>
<span class="nc" id="L271">                        thenComparing(Application::getCreatedDate).reversed()).map(AppInfo::new).toList();</span>
<span class="nc" id="L272">        return SaResult.data(appInfos);</span>
    }
    /*
    获取自己关于某个基金的所有申请
     */
    public SaResult getMyAppsOfExpend(String expendNumber, long userId){
<span class="nc bnc" id="L278" title="All 2 branches missed.">        if(userDao.findByUserId(userId) == null){</span>
<span class="nc" id="L279">            return SaResult.error(&quot;the user is not exist&quot;);</span>
        }
<span class="nc" id="L281">        List&lt;AppInfo&gt; appInfos = userDao.findByUserId(userId).getApplications().stream()</span>
<span class="nc" id="L282">                .filter(s-&gt;s.getExpenditure().getNumber().equals(expendNumber))</span>
<span class="nc" id="L283">                .sorted(Comparator.comparing(Application::getStatus).thenComparing(Application::getCreatedDate)).map(AppInfo::new).toList();</span>
<span class="nc" id="L284">        return SaResult.data(appInfos);</span>
    }

    /*
    获得自己需要审批的app
    1. 遍历自己的appToExam，需要保留一个审批记录，所以返回的排序先按照状态号，再按照申请时间
     */
    @Override
    public SaResult getMyAppsToExam(long userId) {
<span class="nc bnc" id="L293" title="All 2 branches missed.">        if(userDao.findByUserId(userId) == null){</span>
<span class="nc" id="L294">            return SaResult.error(&quot;the user is not exist&quot;);</span>
        }
//        这里获得的app应该都是填好了全部的（有expend
//        List&lt;AppInfo&gt; appInfos = userDao.findById(userId).get().getAppToExam().stream()
//                .sorted(Comparator.comparing(Application::getStatus).thenComparing(Application::getCreatedDate)).map(AppInfo::new).toList();
<span class="nc" id="L299">        List&lt;AppInfo&gt; appInfos = userDao.findByUserId(userId).getAppToExam().stream()</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">                .filter(s-&gt;s.getStatus() == 0).map(AppInfo::new).toList();</span>
<span class="nc" id="L301">        return SaResult.data(appInfos);</span>
    }

    /*
    1. 判断这个user是否在app所在的组里
    2. TODO 获得对象之后直接处理是否可以反映到数据库-不可以
     */
    @Override
    public SaResult passApplication(long userId, String appId, String comment) {
<span class="fc" id="L310">        long appID = 0;</span>
//        检查appID是否为整数
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">        if (isInteger(appId)){</span>
<span class="fc" id="L313">            appID = Integer.parseInt(appId);</span>
        }else{
<span class="nc" id="L315">            return SaResult.error(&quot;this id is not int&quot;);</span>
        }
//        application不为空,
<span class="fc" id="L318">        System.out.println(&quot;start to find application&quot;);</span>
<span class="fc" id="L319">        Application application = applicationDao.findById(appID);</span>
<span class="fc" id="L320">        System.out.println(&quot;find application&quot;);</span>
<span class="pc bpc" id="L321" title="1 of 2 branches missed.">        if(application == null){</span>
<span class="nc" id="L322">            return SaResult.error(&quot;this appId &quot;+ appId + &quot; is not exist&quot;);</span>
        }
//        user不为空
<span class="fc" id="L325">        User user = userDao.findByUserId(userId);</span>
<span class="pc bpc" id="L326" title="1 of 2 branches missed.">        if(user == null){</span>
<span class="nc" id="L327">            return SaResult.error(&quot;this userId &quot;+ userId + &quot; is not exist&quot;);</span>
        }
//        判断application是否可以被修改
<span class="pc bpc" id="L330" title="1 of 2 branches missed.">        if (application.getStatus() != 0){</span>
<span class="nc" id="L331">            return SaResult.error(&quot;this application can not be modified&quot;);</span>
        }
//        检查这个人是否有权限修改
<span class="fc" id="L334">        if(application.getExpenditure().getGroup().getUsers().stream()</span>
<span class="fc" id="L335">                .map(s-&gt;s.getEmail()+s.getIdentity()).toList()</span>
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">                .contains(user.getEmail()+user.getIdentity())){</span>
<span class="nc" id="L337">            applicationDao.updateStatusById(1, application.getId());</span>
//            expenditureDao.updateRemainingAmountByNumber(
//                    application.getExpenditure().getRemainingAmount()+application.getAmount(),
//                    application.getExpenditure().getNumber());
<span class="nc" id="L341">            Feedback feedback = new Feedback();</span>
<span class="nc" id="L342">            feedback.setComment(comment);</span>
<span class="nc" id="L343">            feedback.setReplyTime(new Date());</span>
<span class="nc" id="L344">            feedback.setCreatedDate(new Date());</span>
<span class="nc" id="L345">            feedback.setUser(user);</span>
<span class="nc" id="L346">            feedback.setApplicationId(application.getId());</span>
<span class="nc" id="L347">            feedback.setRead(0);</span>
<span class="nc" id="L348">            feedbackDao.save(feedback);</span>
//          申请者会收到feedback
<span class="nc" id="L350">            application.getUser().getFeedbacks().add(feedback);</span>
<span class="nc" id="L351">            userDao.save(application.getUser());</span>
<span class="nc" id="L352">            return SaResult.ok(&quot;pass&quot;);</span>
        }else{
<span class="fc" id="L354">            return SaResult.error(&quot;this user can not pass the application&quot;);</span>
        }
    }

    @Override
    public SaResult rejectApplication(long userId, String appId, String comment) {
<span class="fc" id="L360">        long appID = 0;</span>
<span class="pc bpc" id="L361" title="1 of 2 branches missed.">        if (isInteger(appId)){</span>
<span class="fc" id="L362">            appID = Integer.parseInt(appId);</span>
        }else{
<span class="nc" id="L364">            return SaResult.error(&quot;this id is not int&quot;);</span>
        }
<span class="fc" id="L366">        Application application = applicationDao.findById(appID);</span>
<span class="pc bpc" id="L367" title="1 of 2 branches missed.">        if(application == null){</span>
<span class="nc" id="L368">            return SaResult.error(&quot;this appId &quot;+ appId + &quot; is not exist&quot;);</span>
        }
<span class="fc" id="L370">        User user = userDao.findByUserId(userId);</span>
<span class="pc bpc" id="L371" title="1 of 2 branches missed.">        if(user == null){</span>
<span class="nc" id="L372">            return SaResult.error(&quot;this userId &quot;+ userId + &quot; is not exist&quot;);</span>
        }
<span class="pc bpc" id="L374" title="1 of 2 branches missed.">        if (application.getStatus() != 0){</span>
<span class="nc" id="L375">            return SaResult.error(&quot;this application can not be modified&quot;);</span>
        }
<span class="fc" id="L377">        if(application.getExpenditure().getGroup().getUsers().stream()</span>
<span class="fc" id="L378">                .map(s-&gt;s.getEmail()+s.getIdentity()).toList()</span>
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">                .contains(user.getEmail()+user.getIdentity())){</span>
<span class="nc" id="L380">            applicationDao.updateStatusById(2, application.getId());</span>
<span class="nc" id="L381">            Feedback feedback = new Feedback();</span>
<span class="nc" id="L382">            feedback.setComment(comment);</span>
<span class="nc" id="L383">            feedback.setReplyTime(new Date());</span>
<span class="nc" id="L384">            feedback.setCreatedDate(new Date());</span>
<span class="nc" id="L385">            feedback.setUser(user);</span>
<span class="nc" id="L386">            feedback.setApplicationId(application.getId());</span>
<span class="nc" id="L387">            feedback.setRead(0);</span>
<span class="nc" id="L388">            feedbackDao.save(feedback);</span>
//          申请者会收到feedback
<span class="nc" id="L390">            application.getUser().getFeedbacks().add(feedback);</span>
<span class="nc" id="L391">            userDao.save(application.getUser());</span>
<span class="nc" id="L392">            expenditureDao.updateRemainingAmountByNumber(</span>
<span class="nc" id="L393">                    application.getExpenditure().getRemainingAmount()+application.getAmount(),</span>
<span class="nc" id="L394">                    application.getExpenditure().getNumber());</span>
<span class="nc" id="L395">            return SaResult.ok(&quot;reject&quot;);</span>
        }else{
<span class="fc" id="L397">            return SaResult.error(&quot;this user can not reject the application&quot;);</span>
        }
    }

    /*
    1. 获得的是自己需要审批的所有基金申请
    2. 通过申请之后，该基金正式建立，加入小组等
    3. 拒绝之后没有具体变化
     */
    public SaResult getMyExpendsToExam(long userId){
<span class="nc bnc" id="L407" title="All 2 branches missed.">        if(userDao.findByUserId(userId) == null){</span>
<span class="nc" id="L408">            return SaResult.error(&quot;the user is not exist&quot;);</span>
        }
        /*
        利用AppInfo类，同时申请的信息也会插入数据库，但是只有标志位为1才能被组选来申请application
        下面这句表示没被处理的放前面，相同处理状态的按照时间排序
         */
//        List&lt;ExpendInfo&gt; expInfos = userDao.findById(userId).get().getExpendToExam().stream()
//                .sorted(Comparator.comparing(Expenditure::getStatus).thenComparing(Expenditure::getCreatedDate)).map(ExpendInfo::new).toList();
<span class="nc" id="L416">        List&lt;ExpendInfo&gt; expInfos = userDao.findByUserId(userId).getExpendToExam().stream()</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">                .filter(s-&gt;s.getStatus()==0).map(ExpendInfo::new).toList();</span>
<span class="nc" id="L418">        return SaResult.data(expInfos);</span>
    }
//    TODO quota是管理员设置？
    public SaResult submitExpend(String expName, String expNumber, String totalAmound,
                                 String startTime, String endTime, String groupName, long userId) throws ParseException {
<span class="fc" id="L423">        return saveExpend(expName, expNumber, totalAmound,</span>
                startTime, endTime, groupName, userId, 0);
        }
        public SaResult tempSaveExpend(String expName, String expNumber, String totalAmound,
                                       String startTime, String endTime, String groupName, long userId) throws ParseException {
<span class="fc" id="L428">            return saveExpend(expName, expNumber, totalAmound,</span>
                    startTime, endTime, groupName, userId, 4);
        }
    private SaResult saveExpend(String expName, String expNumber, String totalAmound,
                                String startTime, String endTime, String groupName, long userId, int saveStatus) throws ParseException {
        /*
        验证各种关系：是否存在这个人/小组，小组包含人？小组已有该基金？
        检验小信息：时间（没有很严格）
         */
//        当前用户与申请小组的检测
<span class="fc" id="L438">        User user = userDao.findByUserId(userId);</span>
<span class="pc bpc" id="L439" title="1 of 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L440">            return SaResult.error(&quot;this user is not exist&quot;);</span>
        }
<span class="fc" id="L442">        Group group = groupDao.findByName(groupName);</span>
<span class="pc bpc" id="L443" title="1 of 2 branches missed.">        if (group == null) {</span>
<span class="nc" id="L444">            return SaResult.error(&quot;this group is not exist&quot;);</span>
        }
<span class="fc" id="L446">        if (!group.getUsers().stream().map(s -&gt; s.getEmail() + s.getIdentity()).toList()</span>
<span class="fc bfc" id="L447" title="All 2 branches covered.">                .contains(user.getEmail() + user.getIdentity())) {</span>
<span class="fc" id="L448">            return SaResult.error(&quot;this user cannot submit this expenditure application for this group&quot;);</span>
        }
//        number存在
<span class="fc" id="L451">        Optional&lt;Expenditure&gt; e0 = group.getExpenditures().stream().filter(s -&gt; s.getNumber().equals(expNumber))</span>
<span class="fc" id="L452">                .findFirst();</span>
<span class="pc bpc" id="L453" title="1 of 2 branches missed.">        if (e0.isPresent()) {</span>
<span class="nc" id="L454">            return SaResult.error(&quot;this expenditure number has been exist&quot;);</span>
        }
//      检测amount是否
<span class="fc" id="L457">        double amt = 0.0;</span>
<span class="pc bpc" id="L458" title="1 of 2 branches missed.">        if (isDouble(totalAmound)) {</span>
<span class="fc" id="L459">            amt = Double.parseDouble(totalAmound);</span>
        } else {
<span class="nc" id="L461">            return SaResult.error(&quot;this amount is not double&quot;);</span>
        }
<span class="pc bpc" id="L463" title="1 of 2 branches missed.">        if (amt &lt; 0) {</span>
<span class="nc" id="L464">            return SaResult.error(&quot;the amount is illegal &quot;);</span>
        }
//        时间的简单检测
<span class="fc" id="L467">        SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span>
<span class="fc" id="L468">        Date start = sdf.parse(startTime), end = sdf.parse(endTime);</span>
<span class="pc bpc" id="L469" title="1 of 2 branches missed.">        if (start.after(end)) {</span>
<span class="nc" id="L470">            return SaResult.error(&quot;the start time is after end&quot;);</span>
        }
//        检查是否已存在
<span class="pc bpc" id="L473" title="1 of 2 branches missed.">        if (group.getExpenditures().stream().map(Expenditure::getNumber).toList().contains(expNumber)) {</span>
<span class="nc" id="L474">            return SaResult.error(&quot;This expenditure has been exist&quot;);</span>
        }
//      提交与保存
<span class="fc" id="L477">        Expenditure e = new Expenditure();</span>
<span class="fc" id="L478">        e.setName(expName);</span>
<span class="fc" id="L479">        e.setNumber(expNumber);</span>
<span class="fc" id="L480">        e.setTotalAmount(amt);</span>
<span class="fc" id="L481">        e.setRemainingAmount(amt);</span>
<span class="fc" id="L482">        e.setCreatedDate(new Date());</span>
<span class="fc" id="L483">        e.setApplications(new HashSet&lt;&gt;());</span>
<span class="fc" id="L484">        e.setStartTime(start);</span>
<span class="fc" id="L485">        e.setEndTime(end);</span>
<span class="fc" id="L486">        e.setGroup(group);</span>
<span class="fc" id="L487">        e.setQuota(amt);</span>
<span class="fc" id="L488">        e.setStatus(saveStatus);</span>
<span class="fc" id="L489">        e.setType(0);</span>
<span class="fc" id="L490">        Expenditure expenditure = expenditureDao.save(e);</span>
<span class="pc bpc" id="L491" title="1 of 2 branches missed.">        if (saveStatus==0) {</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">            group.getUsers().stream().filter(s -&gt; s.getIdentity() &gt; 0).forEach(s -&gt; {</span>
<span class="nc" id="L493">                s.getExpendToExam().add(expenditure);</span>
//            userDao.save(s);
<span class="nc" id="L495">            });</span>
        }
<span class="fc" id="L497">        ExpendInfo expendInfo = new ExpendInfo(expenditure);</span>
<span class="fc" id="L498">        userDao.updateSexById(user.getSex(), user.getId());</span>
<span class="fc" id="L499">        return SaResult.ok().setData(expendInfo);</span>
    }

    public SaResult getTempSaveExpend(Long userId){
<span class="nc bnc" id="L503" title="All 2 branches missed.">        if (userId == null){</span>
<span class="nc" id="L504">            return SaResult.error(&quot;userId is null&quot;);</span>
        }
<span class="nc" id="L506">        List&lt;Expenditure&gt; expenditures = expenditureDao.findByIdAndStatus(userId, 4);</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">        if (expenditures.size() == 0){</span>
<span class="nc" id="L508">            return SaResult.error(&quot;no temp save&quot;);</span>
        }
<span class="nc" id="L510">        Expenditure expenditure = new Expenditure();</span>
<span class="nc" id="L511">        expenditure.setName(&quot;no app find&quot;);</span>
<span class="nc" id="L512">        return SaResult.ok().setData(new ExpendInfo(expenditures.stream()</span>
<span class="nc" id="L513">                .max(Comparator.comparing(Expenditure::getCreatedDate)).orElse(expenditure)));</span>
    }

    public SaResult checkUserAndExpend(User user, Expenditure expenditure){
<span class="nc bnc" id="L517" title="All 2 branches missed.">        if (user == null){</span>
<span class="nc" id="L518">            return SaResult.error(&quot;this user is not exist&quot;);</span>
        }
<span class="nc bnc" id="L520" title="All 2 branches missed.">        if (expenditure == null){</span>
<span class="nc" id="L521">            return SaResult.error(&quot;this expenditure is not exist&quot;);</span>
        }
<span class="nc bnc" id="L523" title="All 2 branches missed.">        if (user.getIdentity()==0){</span>
<span class="nc" id="L524">            return SaResult.error(&quot;this person has no right to pass&quot;);</span>
        }
<span class="nc bnc" id="L526" title="All 2 branches missed.">        if (!expenditure.getGroup().getUsers().contains(user)){</span>
<span class="nc" id="L527">            return SaResult.error(&quot;this person not in the group of the expenditure&quot;);</span>
        }
<span class="nc" id="L529">        return SaResult.ok();</span>
    }
    public SaResult passExpenditure(long userId, String expId){
<span class="nc" id="L532">        long expID = 0;</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">        if (isInteger(expId)){</span>
<span class="nc" id="L534">            expID = Integer.parseInt(expId);</span>
        }else{
<span class="nc" id="L536">            return SaResult.error(&quot;this expenditure ID is not integer&quot;);</span>
        }
<span class="nc" id="L538">        User user = userDao.findByUserId(userId);</span>
<span class="nc" id="L539">        Expenditure expenditure = expenditureDao.findById(expID);</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">        if (expenditure.getStatus() != 0){</span>
<span class="nc" id="L541">            return SaResult.error(&quot;this expenditure can not be modified&quot;);</span>
        }
<span class="nc bnc" id="L543" title="All 2 branches missed.">        if (expenditureDao.existsByNumberAndStatus(expenditure.getNumber(), 1)){</span>
<span class="nc" id="L544">            expenditureDao.updateStatusById(2, expenditure.getId());</span>
<span class="nc" id="L545">            return SaResult.error(&quot;this expenditure has been set up&quot;);</span>
        }
<span class="nc" id="L547">        SaResult res = checkUserAndExpend(user, expenditure);</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">        if (res.getCode()==200){</span>
<span class="nc" id="L549">            int expenditure1 = expenditureDao.updateStatusById(1, expID);</span>
<span class="nc" id="L550">            expenditure.getGroup().getExpenditures().add(expenditure);</span>
<span class="nc" id="L551">            expenditureDao.save(expenditure);</span>
<span class="nc" id="L552">            return SaResult.ok().setData(expenditure1);</span>
<span class="nc" id="L553">        }else return res;</span>
    }
    public SaResult rejectExpenditure(long userId, String expId){
<span class="nc" id="L556">        long expID = 0;</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">        if (isInteger(expId)){</span>
<span class="nc" id="L558">            expID = Integer.parseInt(expId);</span>
        }else{
<span class="nc" id="L560">            return SaResult.error(&quot;this expenditure ID is not integer&quot;);</span>
        }
<span class="nc" id="L562">        User user = userDao.findByUserId(userId);</span>
<span class="nc" id="L563">        Expenditure expenditure = expenditureDao.findById(expID);</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">        if (expenditure.getStatus() != 0){</span>
<span class="nc" id="L565">            return SaResult.error(&quot;this expenditure can not be modified&quot;);</span>
        }
<span class="nc" id="L567">        SaResult res = checkUserAndExpend(user, expenditure);</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">        if (res.getCode()==200){</span>
<span class="nc" id="L569">            int expenditure1 = expenditureDao.updateStatusById(2, expID);</span>
<span class="nc" id="L570">            return SaResult.ok().setData(expenditure1);</span>
<span class="nc" id="L571">        }else return res;</span>
    }


    /*
        建立新的expend，填写具体的expend 名称
        报错：
        1. 填写的组别不属于该用户属于的组
        2. 填写的时间不对
        3. 该经费不存在（这个交给上面去审核）

        TODO 这里是直接创建，之后写一个申请的方法，申请通过后才正式创建
     */
    public SaResult newExpenditureApplication(String expenditureName, String groupName, String expenditureNumber,
                                          String expenditureTotalAmount, String beginTime, String endTime, long userId) throws ParseException {
<span class="fc" id="L586">        double expTotalAmt = 0;</span>
<span class="pc bpc" id="L587" title="1 of 2 branches missed.">        if (isDouble(expenditureTotalAmount)){</span>
<span class="fc" id="L588">            expTotalAmt = Integer.parseInt(expenditureTotalAmount);</span>
        }else{
<span class="nc" id="L590">            return SaResult.error(&quot;this total amount is not double&quot;);</span>
        }
<span class="fc" id="L592">        Expenditure expenditure = new Expenditure();</span>
<span class="fc" id="L593">        expenditure.setName(expenditureName);</span>
<span class="fc" id="L594">        expenditure.setNumber(expenditureNumber);</span>
<span class="fc" id="L595">        expenditure.setTotalAmount(expTotalAmt);</span>
<span class="fc" id="L596">        expenditure.setRemainingAmount(expTotalAmt);</span>
<span class="fc" id="L597">        SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span>
<span class="fc" id="L598">        Date start = sdf.parse(beginTime), end = sdf.parse(beginTime);</span>
<span class="pc bpc" id="L599" title="1 of 2 branches missed.">        if(start.after(end)){</span>
<span class="nc" id="L600">            return SaResult.error(&quot;begin time is after end&quot;).setData(-1);</span>
        }
<span class="fc" id="L602">        expenditure.setStartTime(start);</span>
<span class="fc" id="L603">        expenditure.setEndTime(end);</span>
<span class="fc" id="L604">        Group group = groupDao.findByName(groupName);</span>
<span class="pc bpc" id="L605" title="1 of 2 branches missed.">        if(group == null){</span>
<span class="nc" id="L606">            return SaResult.error(String.format(&quot;this group %s is not exist\n&quot;, groupName)).setData(-1);</span>
        }
<span class="fc" id="L608">        GroupInfo groupInfo = new GroupInfo(group);</span>
<span class="fc" id="L609">        User user = userDao.findByUserId(userId);</span>
<span class="pc bpc" id="L610" title="1 of 2 branches missed.">        if (user == null){</span>
<span class="nc" id="L611">            return SaResult.error(String.format(&quot;this user %d is not exist\n&quot;,userId)).setData(-1);</span>
        }
<span class="pc bpc" id="L613" title="1 of 2 branches missed.">        if (!groupInfo.getMemberNames().contains(user.getName())){</span>
//        if (!group.getUsers().contains(user.get())){
<span class="nc" id="L615">            return SaResult.error(String.format(&quot;this user %d is not belong to this group %s&quot;, userId, groupName)).setData(-1);</span>
        }
<span class="fc" id="L617">        expenditure.setGroup(groupDao.findByName(groupName));</span>
<span class="fc" id="L618">        expenditure.setApplications(new HashSet&lt;&gt;());</span>
<span class="fc" id="L619">        expenditure.setQuota(0);</span>

//        将这个申请交给管理者
<span class="fc" id="L622">        Expenditure expenditure1 = expenditureDao.save(expenditure);</span>
<span class="fc bfc" id="L623" title="All 2 branches covered.">        group.getUsers().stream().filter(s-&gt;s.getIdentity()&gt;0).forEach(s-&gt;s.getExpenditures().add(expenditure1));</span>
<span class="fc" id="L624">        return SaResult.ok(&quot;success!&quot;).setData(expenditure1.getId());</span>

    }

    /*
    获得这个用户所有可以申请的基金
     */
    public SaResult getAllMyExpends(long userId){
<span class="nc" id="L632">        User user = userDao.findByUserId(userId);</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">        if (user == null){</span>
<span class="nc" id="L634">            return SaResult.error(&quot;this user is not exist&quot;);</span>
        }
<span class="nc" id="L636">        List&lt;ExpendInfo&gt; expendInfos = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L637">        user.getGroups().forEach(s-&gt;s.getExpenditures().forEach(m-&gt;expendInfos.add(new ExpendInfo(m))));</span>
<span class="nc" id="L638">        Set&lt;Group&gt; groups = user.getGroups();</span>
<span class="nc" id="L639">        groups.stream().forEach(s-&gt;{</span>
//            System.out.println(s.getName());
<span class="nc" id="L641">            s.getExpenditures().stream().forEach(m-&gt; System.out.println(m.getName()));</span>
//            System.out.println(&quot;finished &quot;+ s.getName());
<span class="nc" id="L643">        });</span>

<span class="nc" id="L645">        return SaResult.ok().setData(expendInfos);</span>
    }


    /*
    csv文件提出申请
     */

    public SaResult uploadCsvFileToApply(MultipartFile file, long userId){
<span class="nc" id="L654">        User user = userDao.findByUserId(userId);</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">        if (user==null){</span>
<span class="nc" id="L656">            return SaResult.error(&quot;this user is not exist&quot;);</span>
        }
<span class="nc bnc" id="L658" title="All 2 branches missed.">        if (file.isEmpty()){</span>
<span class="nc" id="L659">            return SaResult.error(&quot;this file is empty&quot;);</span>
        }
<span class="nc" id="L661">        String fileName = file.getOriginalFilename();</span>
<span class="nc" id="L662">        String suffixName = null;</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">        if (fileName != null) {</span>
<span class="nc" id="L664">            suffixName = fileName.substring(fileName.lastIndexOf(&quot;.&quot;));</span>
        }
<span class="nc bnc" id="L666" title="All 4 branches missed.">        if (suffixName != null &amp;&amp; !suffixName.equals(&quot;.xlsx&quot;)) {</span>
<span class="nc" id="L667">            return SaResult.error(&quot;this file is not xlsx&quot;);</span>
        }
<span class="nc" id="L669">        InputStream inputStream = null;</span>
<span class="nc" id="L670">        List&lt;AppExcel&gt; appExcels = null;</span>
        try {
<span class="nc" id="L672">            inputStream = file.getInputStream();</span>
            // 使用输入流进行操作
<span class="nc" id="L674">            appExcels = EasyExcel.read(inputStream).head(AppExcel.class).sheet(0).doReadSync();</span>
<span class="nc" id="L675">        } catch (FileNotFoundException e) {</span>
<span class="nc" id="L676">            e.printStackTrace();</span>
            // 处理文件不存在的情况
<span class="nc" id="L678">        } catch (IOException e) {</span>
<span class="nc" id="L679">            throw new RuntimeException(e);</span>
        } finally {
<span class="nc bnc" id="L681" title="All 2 branches missed.">            if (inputStream != null) {</span>
                try {
<span class="nc" id="L683">                    inputStream.close();</span>
<span class="nc" id="L684">                } catch (IOException e) {</span>
<span class="nc" id="L685">                    e.printStackTrace();</span>
                    // 处理关闭输入流时的异常
<span class="nc" id="L687">                }</span>
            }
        }
<span class="nc bnc" id="L690" title="All 2 branches missed.">        if (appExcels != null) {</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">            for (AppExcel appExcel : appExcels) {</span>
<span class="nc" id="L692">                SaResult res = submitApplication(appExcel.getExpenditureId(), appExcel.getCategory1(),appExcel.getCategory2(),</span>
<span class="nc" id="L693">                        appExcel.getAbstracts(), appExcel.getComment(), appExcel.getAmount(), StpUtil.getLoginIdAsLong());</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">                if (res.getCode() != 200) {</span>
<span class="nc" id="L695">                    return res;</span>
                }
                //按理说应该回退
<span class="nc" id="L698">            }</span>
        }
<span class="nc" id="L700">        return SaResult.ok();</span>
    }

    public SaResult downloadCsvFileApplyFromOneExp(HttpServletResponse response, String expenditureNumber, long userId){
<span class="nc" id="L704">        List&lt;AppExcel&gt; appExcels = CreateDataList();</span>
        try{
<span class="nc" id="L706">            response.setContentType(&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;);</span>
<span class="nc" id="L707">            response.setCharacterEncoding(&quot;utf-8&quot;);</span>
<span class="nc" id="L708">            String fileName = URLEncoder.encode(&quot;经费明细表&quot;, StandardCharsets.UTF_8);</span>
<span class="nc" id="L709">            response.setHeader(&quot;Content-disposition&quot;, &quot;attachment;filename*=utf-8''&quot; + fileName + &quot;.xlsx&quot;);</span>
            // 这里需要设置不关闭流
<span class="nc" id="L711">            EasyExcel.write(response.getOutputStream(), User.class).autoCloseStream(Boolean.FALSE).sheet(&quot;员工&quot;)</span>
<span class="nc" id="L712">                    .doWrite(appExcels);</span>
<span class="nc" id="L713">        }catch (Exception e) {</span>
            // 重置response
<span class="nc" id="L715">            response.reset();</span>
<span class="nc" id="L716">            response.setContentType(&quot;application/json&quot;);</span>
<span class="nc" id="L717">            response.setCharacterEncoding(&quot;utf-8&quot;);</span>
<span class="nc" id="L718">            Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L719">            map.put(&quot;status&quot;, &quot;failure&quot;);</span>
<span class="nc" id="L720">            map.put(&quot;message&quot;, &quot;下载文件失败&quot; + e.getMessage());</span>
<span class="nc" id="L721">            JSONObject jsonObject=new JSONObject();;</span>
            try {
<span class="nc" id="L723">                response.getWriter().println(jsonObject.toString());</span>
<span class="nc" id="L724">            } catch (IOException ioException) {</span>
<span class="nc" id="L725">                ioException.printStackTrace();</span>
<span class="nc" id="L726">            }</span>
<span class="nc" id="L727">        }</span>
<span class="nc" id="L728">        return SaResult.ok();</span>
    }

    private List&lt;AppExcel&gt; CreateDataList(){
<span class="nc" id="L732">        return null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>